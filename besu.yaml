version: "3.8"
services:

  jbc-execution:
    container_name: jbc-execution
    image: hyperledger/besu:latest
    user: root
    command:
      - --genesis-file=/genesis.json
      - --data-path=/datadir
      - --rpc-ws-enabled
      - --rpc-http-enabled
      - --engine-jwt-secret=/config/jwt.hex
      - --p2p-host=${NODE_PUBLIC_IP}
      - --host-allowlist=*
      - --nat-method=DOCKER
      - --bootnodes=enode://f06e9a7b61376bcd95df21cd6f624c46c62c8fe5b18faa96d85542bb08aa3af0c0726291cab36f30917e34ab35e0ba064ac811f5c4ac7e836d2ce95447975d5e@135.181.4.243:32323
    volumes:
      - ./genesis.json:/genesis.json
      - ./data:/datadir
      - ./config:/config
    ports:
      - 30303:30303
      - 8545:8545
    restart: always

  jbc-consensus:
    container_name: jbc-consensus
    image: sigp/lighthouse:v5.0.0
    user: root
    entrypoint: /root/lighthouse-script.sh
    command:
      - lighthouse
      - beacon
      - --execution-endpoint=http://jbc-execution:8551
      - --execution-jwt=/config/jwt.hex
      - --testnet-dir=/config
      - --http-allow-sync-stalled
      - --disable-peer-scoring
      - --http
      - --http-address=0.0.0.0
      - --http-port=5002
      - --disable-packet-filter
      - --eth1
      - --target-peers=${TARGET_PEERS}
      - --enr-address=${NODE_PUBLIC_IP}
      - --enr-udp-port=9100
      - --enr-tcp-port=9100
      - --port=9100
      - --checkpoint-sync-url=https://metrabyte-cl.jibchain.net/
      - --prune-blobs=false
    volumes:
      - ./data/lighthouse:/root/.lighthouse
      - ./config:/config
      - ./lighthouse-script.sh:/root/lighthouse-script.sh
    ports:
      - 0.0.0.0:9100:9100/tcp
      - 0.0.0.0:9100:9100/udp
      - 0.0.0.0:5002:5002/tcp
      - 0.0.0.0:5002:5002/udp
